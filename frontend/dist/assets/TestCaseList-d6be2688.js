import{_ as _e,u as fe,q as u,x as ve,r as i,S as ge,o as v,c as V,b as T,J as $,w as s,B as O,d as t,N as me,C as S,e as d,E as W,g as N,H as he,f as c,t as m,T as ye,D as we,U as be,F as K,y as Q,G as Ce,R as xe}from"./index-b9247cb2.js";import{u as M,w as Te}from"./xlsx-f5126985.js";const ke={class:"page-container"},Ve={class:"page-header"},$e={class:"header-actions"},Se={class:"card-container"},Me={class:"filter-bar"},De={key:0,class:"version-tags"},je={key:1,class:"no-version"},ze={class:"pagination-container"},Be={__name:"TestCaseList",setup(Ee){const I=fe(),k=u(!1),L=u([]),Y=u([]),b=u(1),A=u(20),H=u(0),D=u(""),j=u(""),z=u(""),B=u(""),y=u([]),U=u(!1),C=async()=>{k.value=!0;try{const e={page:b.value,search:D.value,project:j.value,priority:z.value,status:B.value},a=await S.get("/testcases/",{params:e});L.value=a.data.results||[],H.value=a.data.count||0}catch{d.error("获取测试用例列表失败")}finally{k.value=!1}},X=()=>{b.value=1,C()},P=()=>{b.value=1,C()},Z=()=>{C()},ee=e=>{I.push(`/ai-generation/testcases/${e}`)},te=e=>{I.push(`/ai-generation/testcases/${e.id}/edit`)},ae=async e=>{try{await W.confirm("确定要删除这个测试用例吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await S.delete(`/testcases/${e.id}/`),d.success("测试用例删除成功"),C()}catch(a){a!=="cancel"&&d.error("测试用例删除失败")}},le=e=>{y.value=e},se=e=>(b.value-1)*A.value+e+1,ne=async()=>{if(y.value.length===0){d.warning("请先选择要删除的测试用例");return}try{await W.confirm(`确定要删除选中的 ${y.value.length} 个测试用例吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),U.value=!0;let e=0,a=0;for(const p of y.value)try{await S.delete(`/testcases/${p.id}/`),e++}catch(r){console.error(`删除测试用例 ${p.id} 失败:`,r),a++}e>0?d.success(`成功删除 ${e} 个测试用例${a>0?`，${a} 个失败`:""}`):d.error("删除失败"),y.value=[],C()}catch(e){e!=="cancel"&&(console.error("批量删除失败:",e),d.error("批量删除失败: "+(e.message||"未知错误")))}finally{U.value=!1}},R=e=>({low:"低",medium:"中",high:"高",critical:"紧急"})[e]||e,oe=e=>({draft:"info",active:"success",deprecated:"warning"})[e]||"info",q=e=>({draft:"草稿",active:"激活",deprecated:"废弃"})[e]||e,G=e=>({functional:"功能测试",integration:"集成测试",api:"API测试",ui:"UI测试",performance:"性能测试",security:"安全测试"})[e]||"-",J=e=>xe(e).format("YYYY-MM-DD HH:mm"),re=e=>e.map(a=>a.name+(a.is_baseline?" (基线)":"")).join("、"),ie=async()=>{try{k.value=!0;const a=(await S.get("/testcases/",{params:{page_size:9999,search:D.value,project:j.value,priority:z.value,status:B.value}})).data.results||[];if(a.length===0){d.warning("没有测试用例数据可导出");return}const p=M.book_new(),r=[["测试用例编号","用例标题","关联项目","关联版本","前置条件","操作步骤","预期结果","优先级","状态","测试类型","作者","创建时间"]];a.forEach((n,f)=>{var E,w;const o=n.versions&&n.versions.length>0?n.versions.map(F=>F.name+(F.is_baseline?"(基线)":"")).join("、"):"未关联版本";r.push([`TC${String(f+1).padStart(3,"0")}`,n.title||"",((E=n.project)==null?void 0:E.name)||"",o,n.preconditions||"",n.steps||"",n.expected_result||"",R(n.priority),q(n.status),G(n.test_type),((w=n.author)==null?void 0:w.username)||"",J(n.created_at)])});const h=M.aoa_to_sheet(r),x=[{wch:15},{wch:30},{wch:20},{wch:25},{wch:30},{wch:40},{wch:30},{wch:10},{wch:10},{wch:15},{wch:15},{wch:20}];h["!cols"]=x;for(let n=0;n<r[0].length;n++){const f=M.encode_cell({r:0,c:n});h[f]&&(h[f].s={font:{bold:!0},alignment:{horizontal:"center",vertical:"center",wrapText:!0}})}for(let n=1;n<r.length;n++)for(let f=0;f<r[n].length;f++){const o=M.encode_cell({r:n,c:f});h[o]&&(h[o].s={alignment:{vertical:"top",wrapText:!0}})}M.book_append_sheet(p,h,"测试用例");const _=`测试用例_${new Date().toISOString().slice(0,10)}.xlsx`;Te(p,_),d.success("测试用例导出成功")}catch(e){console.error("导出测试用例失败:",e),d.error("导出测试用例失败: "+(e.message||"未知错误"))}finally{k.value=!1}},ce=async()=>{try{const e=await S.get("/projects/");Y.value=e.data.results||e.data||[]}catch{d.error("获取项目列表失败")}};return ve(()=>{ce(),C()}),(e,a)=>{const p=i("el-icon"),r=i("el-button"),h=i("el-input"),x=i("el-col"),_=i("el-option"),n=i("el-select"),f=i("el-row"),o=i("el-table-column"),E=i("el-link"),w=i("el-tag"),F=i("el-tooltip"),ue=i("el-table"),de=i("el-pagination"),pe=ge("loading");return v(),V("div",ke,[T("div",Ve,[a[8]||(a[8]=T("h1",{class:"page-title"},"测试用例",-1)),T("div",$e,[y.value.length>0?(v(),$(r,{key:0,type:"danger",onClick:ne,disabled:U.value},{default:s(()=>[t(p,null,{default:s(()=>[t(N(he))]),_:1}),c(" 批量删除 ("+m(y.value.length)+") ",1)]),_:1},8,["disabled"])):O("",!0),t(r,{type:"success",onClick:ie},{default:s(()=>[t(p,null,{default:s(()=>[t(N(ye))]),_:1}),a[6]||(a[6]=c(" 导出Excel ",-1))]),_:1,__:[6]}),t(r,{type:"primary",onClick:a[0]||(a[0]=l=>e.$router.push("/ai-generation/testcases/create"))},{default:s(()=>[t(p,null,{default:s(()=>[t(N(we))]),_:1}),a[7]||(a[7]=c(" 新建用例 ",-1))]),_:1,__:[7]})])]),T("div",Se,[T("div",Me,[t(f,{gutter:20},{default:s(()=>[t(x,{span:5},{default:s(()=>[t(h,{modelValue:D.value,"onUpdate:modelValue":a[1]||(a[1]=l=>D.value=l),placeholder:"搜索用例标题",clearable:"",onInput:X},{prefix:s(()=>[t(p,null,{default:s(()=>[t(N(be))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(x,{span:4},{default:s(()=>[t(n,{modelValue:j.value,"onUpdate:modelValue":a[2]||(a[2]=l=>j.value=l),placeholder:"关联项目",clearable:"",onChange:P},{default:s(()=>[(v(!0),V(K,null,Q(Y.value,l=>(v(),$(_,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(x,{span:3},{default:s(()=>[t(n,{modelValue:z.value,"onUpdate:modelValue":a[3]||(a[3]=l=>z.value=l),placeholder:"优先级筛选",clearable:"",onChange:P},{default:s(()=>[t(_,{label:"低",value:"low"}),t(_,{label:"中",value:"medium"}),t(_,{label:"高",value:"high"}),t(_,{label:"紧急",value:"critical"})]),_:1},8,["modelValue"])]),_:1}),t(x,{span:3},{default:s(()=>[t(n,{modelValue:B.value,"onUpdate:modelValue":a[4]||(a[4]=l=>B.value=l),placeholder:"状态筛选",clearable:"",onChange:P},{default:s(()=>[t(_,{label:"草稿",value:"draft"}),t(_,{label:"激活",value:"active"}),t(_,{label:"废弃",value:"deprecated"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),me((v(),$(ue,{data:L.value,style:{width:"100%"},onSelectionChange:le},{default:s(()=>[t(o,{type:"selection",width:"55"}),t(o,{type:"index",label:"序号",width:"80",index:se}),t(o,{prop:"title",label:"用例标题","min-width":"250"},{default:s(({row:l})=>[t(E,{onClick:g=>ee(l.id),type:"primary"},{default:s(()=>[c(m(l.title),1)]),_:2},1032,["onClick"])]),_:1}),t(o,{prop:"project.name",label:"关联项目",width:"150"},{default:s(({row:l})=>{var g;return[c(m(((g=l.project)==null?void 0:g.name)||"-"),1)]}),_:1}),t(o,{prop:"versions",label:"关联版本",width:"200"},{default:s(({row:l})=>[l.versions&&l.versions.length>0?(v(),V("div",De,[(v(!0),V(K,null,Q(l.versions.slice(0,2),g=>(v(),$(w,{key:g.id,size:"small",type:g.is_baseline?"warning":"info",class:"version-tag"},{default:s(()=>[c(m(g.name),1)]),_:2},1032,["type"]))),128)),l.versions.length>2?(v(),$(F,{key:0,content:re(l.versions)},{default:s(()=>[t(w,{size:"small",type:"info",class:"version-tag"},{default:s(()=>[c(" +"+m(l.versions.length-2),1)]),_:2},1024)]),_:2},1032,["content"])):O("",!0)])):(v(),V("span",je,"未关联版本"))]),_:1}),t(o,{prop:"priority",label:"优先级",width:"100"},{default:s(({row:l})=>[t(w,{class:Ce(`priority-tag ${l.priority}`)},{default:s(()=>[c(m(R(l.priority)),1)]),_:2},1032,["class"])]),_:1}),t(o,{prop:"status",label:"状态",width:"100"},{default:s(({row:l})=>[t(w,{type:oe(l.status)},{default:s(()=>[c(m(q(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(o,{prop:"test_type",label:"测试类型",width:"120"},{default:s(({row:l})=>[c(m(G(l.test_type)),1)]),_:1}),t(o,{prop:"author.username",label:"作者",width:"120"}),t(o,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:l})=>[c(m(J(l.created_at)),1)]),_:1}),t(o,{label:"操作",width:"150",fixed:"right"},{default:s(({row:l})=>[t(r,{size:"small",onClick:g=>te(l)},{default:s(()=>a[9]||(a[9]=[c("编辑",-1)])),_:2,__:[9]},1032,["onClick"]),t(r,{size:"small",type:"danger",onClick:g=>ae(l)},{default:s(()=>a[10]||(a[10]=[c("删除",-1)])),_:2,__:[10]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[pe,k.value]]),T("div",ze,[t(de,{"current-page":b.value,"onUpdate:currentPage":a[5]||(a[5]=l=>b.value=l),"page-size":A.value,total:H.value,layout:"total, prev, pager, next",onCurrentChange:Z},null,8,["current-page","page-size","total"])])])])}}},Ue=_e(Be,[["__scopeId","data-v-27fe09d5"]]);export{Ue as default};
